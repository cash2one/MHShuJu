<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="renderer" content="webkit" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
<meta name="keywords" content="河南移动，教育门户，校讯通，同步课堂，中小学学习报" />
<meta name="Description" content="河南移动教育门户————河南移动各类教育产品统一管理门户网站" />
<title>确认订单信息</title>
<link rel="stylesheet" type="text/css" href="../theme/common.css?v=20141112"/>
<link rel="stylesheet" type="text/css" href="../lib/dialog/4.1.7/skins/blue.css"/>
</head>
<body>
<div class="ui-wrapper">
	<div class="ui-head">
		<div style="width:1024px;margin:0 auto;">
			<div class="ui-hello fn-left">您好，请用河南移动手机号码<a class="ui-nav-login" href="login.html">登录</a>！</div>
			<ul class="ui-nav-list">
			    <li class="ui-nav-hej"><a href="javascript:;">和教育</a></li>
				<li class="ui-nav-index"><a href="index.html">首页</a></li>
				<li class="ui-nav-app"><a href="javascript:;">我的订单</a></li>
				<li class="ui-nav-collect"><a href="javascript:;">我的收藏</a></li>
				<!-- <li class="ui-nav-info"><a href="#nogo">个人资料</a></li> -->
				<li class="ui-nav-choiceRole"><a href="javascript:;">切换角色</a></li>
				<li class="ui-nav-loginout"><a href="javascript:;">退出</a></li>
			</ul>
		</div>
	</div>
	<div class="ui-cont fn-clear">
		<div class="ui-search">
			<a class="ui-logo" href="index.html"></a>
			<div class="ui-search-cont">
				<input class="ui-search-ipt" id="J_search_ipt" type="text" value="请输入关键字搜索" onblur="if(this.value=='') {this.value='请输入关键字搜索';this.style.color='#999';}" onfocus="if(this.value=='请输入关键字搜索') {this.value='';this.style.color='#333';}" />
				<ul class="ui-hot-kwd fn-clear" id="J_hot_kwd"></ul>
			</div>
			<a class="ui-btn ui-btn-red ui-myCart" href="javascript:;">我的购物车(<span>0</span>)</a>
		</div>
		<div class="ui-pers-cent">
			<ul class="ui-pers-list">
				<li class="ui-pers-cart"><a href="sCart.html"><b></b>查看购物车</a></li>
				<li class="ui-pers-order ui-pers-list-cur"><a href="myOrder.html"><b></b>我的订单</a></li>
				<li class="ui-pers-clt"><a href="myCollect.html"><b></b>我的收藏</a></li>
				<li class="ui-pers-accBind"><a href="accountBinding.html"><b></b>账号绑定</a></li>
				<li class="ui-pers-choiceRole"><a href="javascript:;"><b></b>切换角色</a></li>
			</ul>
		</div>
		<div class="ui-right-cont">
			<!-- 面包屑 -->
			<div class="ui-crumbs-wrap">
				<ul class="ui-crumbs fn-clear" style="margin: 0 auto;">
					<li class="ui-step ui-step-done">
						<div class="ui-step-num">STEP.01</div>
						<div class="ui-step-text step1">查看购物车</div>
					</li>
					<li class="ui-arrows ui-arrows-done"></li>
					<li class="ui-step ui-step-cur">
						<div class="ui-step-num">STEP.02</div>
						<div class="ui-step-text">确认订单信息</div>
					</li>
					<li class="ui-arrows"></li>
					<li class="ui-step ui-step3">
						<div class="ui-step-num">STEP.03</div>
						<div class="ui-step-text">办理结果</div>
					</li>
				</ul>
				<div class="ui-split-solid"></div>
			</div>
			<div class="ui-binding-title" style="margin: 30px 0 10px;">订单信息<span style="font-size:14px;font-weight: 500;margin: 0 0 0 20px;color: red;">请注意：该产品订购后将无法退订，谢谢！</span></div>
			<div class="ui-circle-tl">
				<div class="ui-circle-tr"><span></span></div>
				<div class="ui-circle-body"  style="padding:10px 30px;">
					<ul class="ui-plist fn-clear" id="J_plist">
						<div class="ui-loading"><h1><img src="../theme/images/loading.gif" alt="loading">正在为您加载，请稍等 ...</h1></div>
					</ul>
				</div>
				<div class="ui-circle-bl"><em><span></span></em></div>
			</div>
		</div>
	</div>
</div>

<script id="T_plist" type="text/x-handlebars-template">
{{#if this.length}}
	{{#each this}}
		<li class="fn-clear">
			<a href="prodDtl.html?appID={{appID}}&nodeUid={{nodeUid}}&month={{month}}" target="_blank" class="fn-left">
				<img src="../{{appPic}}" width="100" height="56">
			</a>
			<div class="ui-plist-info">
				<a href="prodDtl.html?appID={{appID}}&nodeUid={{nodeUid}}&month={{month}}" class="ui-plist-name" target="_blank">{{appName}}</a>
				<div class="ui-plist-dtl">
					<span>包月：{{month}}个月</span>
				</div>
			</div>
			<div class="ui-plist-price">
				金额：<span style="color:#FE631F;">{{price}}元</span>
			</div>
		</li>
	{{/each}}
	<li class="fn-clear">
		<span style="font-size:16px;display: block;float: left;margin: 6px 0 0 350px;">总计：<span id="J_sumPrice" style="font-size: 20px;color:#FE631F;">0</span>元</span>
		<div style="position: absolute;right: 0px;">
			<a href="javascript:window.history.go(-1);" class="ui-btn ui-btn-sky J_back">返回购物车</a>
			<a href="javascript:;" class="ui-btn ui-btn-orange" onclick="payment()">提交订单</a>
		</div>
	</li>
{{else}}
	<li style="padding:30px 0;font-size:16px;">您还没有订购的产品，快去订购吧~</li>
{{/if}}
</script>

<script type="text/javascript" src="../lib/json2/1.0.0/json2.js"></script>
<script type="text/javascript" src="../lib/jquery/1.8.1/jquery.js"></script>
<script type="text/javascript" src="../lib/jqueryui/1.11.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="../lib/cookie/1.2.0/jquery.cookie.js"></script>
<script type="text/javascript" src="../lib/handlebars/1.3.0/handlebars.js"></script>
<script type="text/javascript" src="../lib/handlebars/1.3.0/helpers.js"></script>
<script type="text/javascript" src="../lib/cryptojs/3.1.2/core-min.js"></script>
<script type="text/javascript" src="../lib/cryptojs/3.1.2/enc-base64-min.js"></script>
<script type="text/javascript" src="../lib/dialog/4.1.7/artDialog.js"></script>
<script type="text/javascript" src="../lib/dialog/4.1.7/iframeTools.js"></script>
<script type="text/javascript" src="../common/config.js"></script>
<script type="text/javascript" src="../common/common.js?v=20141112"></script>
<script type="text/javascript">
//从产品详情跳转至订单页面
var cacheKey = Util.browser.getParameter('cacheKey');
var prodInfo = '';
var payFlag = true;//提交按钮开关
$(function(){
	srvMap.add('submitBill', 'validRtn.json','verifyAllOrder.action?uid=verifyOrder');//提交订单
	srvMap.add('confirmBill', 'confirmBill.json','commonCMS-GetCommonCache.action?uid=getCommonCache');//获取产品信息
	srvMap.add('deleteCar', 'validRtn.json','common.action?uid=delAppCarById');//删除购物车
	var sumPrice = 0;
	Util.ajax.postJson(srvMap.get('confirmBill'),'cacheKey='+cacheKey,function(json,status){
		if (status) {
			prodInfo = json.rows;
			//prev  =1表示从购物车链到该页面；其他表示从产品详细页链到该页面
			if (json.prev == '1') {
				Util.ajax.loadTemp('#J_plist',$('#T_plist'),json.rows);
				for (var i = 0; i < json.rows.length; i++) {
					sumPrice += json.rows[i]['price']?parseFloat(json.rows[i]['price']):0;
				}
			}else{
				$('.step1').text('产品详情');
				Util.ajax.loadTemp('#J_plist',$('#T_plist'),json.rows);
				$('.J_back').text('返回产品详情').attr('href','prodDtl.html?appID='+json.rows[0]['appID']+'&nodeUid='+json.rows[0]['nodeUid']);
				sumPrice += json.rows[0]['price']?parseFloat(json.rows[0]['price']):0;
			}
			$('#J_sumPrice').text(sumPrice);
		}else{

		}
	})
})

//提交订单
function payment(){
	artDialog.confirm('<strong>您确定要提交订单吗？</strong><br>(请注意：该营销活动订购后将无法退订，到期后对应单产品请手动退订！)',function(){
		$('.aui_iconBg').hide();
		var carId = [];
		for(var i in prodInfo){
			carId[i] = prodInfo[i]['carId'];
		}
		prodInfo = JSON.stringify(prodInfo);
		prodInfo = Util.transCoding(prodInfo);
		Util.ajax.postJson(srvMap.get('submitBill'),'prodInfo='+prodInfo,function(json,status){
			if (status) {
				for(var i in carId){
					dltProd(carId[i]);//删除购物车中已购买的产品
				}
				window.location.href = 'doResult.html';
			}else{
				window.location.href = 'doResult.html?rtnMsg='+Util.transCoding(json.rtnMsg);
			}
		})
	})

}

//订单提交成功后需要删除购物车中的该产品
function dltProd(carId){
	Util.ajax.postJson(srvMap.get('deleteCar'),'carId='+carId,function(json,status){
		if (status) {
			//art.dialog.tips(json.rtnMsg||"删除成功！");
		}
	})
}
</script>
</body>
</html>