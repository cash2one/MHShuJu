<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="renderer" content="webkit" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
<meta name="keywords" content="河南移动，教育门户，校讯通，同步课堂，中小学学习报" />
<meta name="Description" content="河南移动教育门户————河南移动各类教育产品统一管理门户网站" />
<title>我的购物车</title>
<link rel="stylesheet" type="text/css" href="../theme/common.css?v=20141112"/>
<link rel="stylesheet" type="text/css" href="../lib/dialog/4.1.7/skins/blue.css"/>
</head>
<body>
<div class="ui-wrapper">
	<div class="ui-head">
		<div style="width:1024px;margin:0 auto;">
			<div class="ui-hello fn-left">您好，请用河南移动手机号码<a class="ui-nav-login" href="login.html">登录</a>！</div>
			<ul class="ui-nav-list">
			    <li class="ui-nav-hej"><a href="javascript:;">和教育</a></li>
				<li class="ui-nav-index"><a href="index.html">首页</a></li>
				<li class="ui-nav-app"><a href="javascript:;">我的订单</a></li>
				<li class="ui-nav-collect"><a href="javascript:;">我的收藏</a></li>
				<!-- <li class="ui-nav-info"><a href="#nogo">个人资料</a></li> -->
				<li class="ui-nav-choiceRole"><a href="javascript:;">切换角色</a></li>
				<li class="ui-nav-loginout"><a href="javascript:;">退出</a></li>
			</ul>
		</div>
	</div>
	<div class="ui-cont fn-clear">
		<div class="ui-search">
			<a class="ui-logo" href="index.html"></a>
			<div class="ui-search-cont">
				<input class="ui-search-ipt" id="J_search_ipt" type="text" value="请输入关键字搜索" onblur="if(this.value=='') {this.value='请输入关键字搜索';this.style.color='#999';}" onfocus="if(this.value=='请输入关键字搜索') {this.value='';this.style.color='#333';}" />
				<ul class="ui-hot-kwd fn-clear" id="J_hot_kwd"></ul>
			</div>
			<a class="ui-btn ui-btn-red ui-myCart" href="javascript:;">我的购物车(<span>0</span>)</a>
		</div>
		<div class="ui-pers-cent">
			<ul class="ui-pers-list">
				<li class="ui-pers-cart ui-pers-list-cur"><a href="sCart.html"><b></b>查看购物车</a></li>
				<li class="ui-pers-order"><a href="myOrder.html"><b></b>我的订单</a></li>
				<li class="ui-pers-clt"><a href="myCollect.html"><b></b>我的收藏</a></li>
				<li class="ui-pers-accBind"><a href="accountBinding.html"><b></b>账号绑定</a></li>
				<li class="ui-pers-choiceRole"><a href="javascript:;"><b></b>切换角色</a></li>
				<li class="ui-pers-changePassword"><a href="changePassword.html"><b></b>修改密码</a></li>
			</ul>
		</div>
		<div class="ui-right-cont">
			<!-- 面包屑 -->
			<div class="ui-crumbs-wrap">
				<ul class="ui-crumbs fn-clear">
					<li class="ui-step ui-step-cur">
						<div class="ui-step-num">STEP.01</div>
						<div class="ui-step-text">查看购物车</div>
					</li>
					<li class="ui-arrows"></li>
					<li class="ui-step">
						<div class="ui-step-num">STEP.02</div>
						<div class="ui-step-text">确认订单信息</div>
					</li>
					<li class="ui-arrows"></li>
					<li class="ui-step ui-step3">
						<div class="ui-step-num">STEP.03</div>
						<div class="ui-step-text">办理结果</div>
					</li>
				</ul>
				<div class="ui-split-solid"></div>
			</div>
			<div class="ui-binding-title" style="margin: 30px 0 10px;">我的购物车</div>
			<div class="ui-circle-tl">
				<div class="ui-circle-tr"><span></span></div>
				<div class="ui-circle-body"  id="J_plist" style="padding:10px 30px;">
					<div class="ui-loading"><h1><img src="../theme/images/loading.gif" alt="loading">正在为您加载，请稍等 ...</h1></div>
				</div>
				<div class="ui-circle-bl"><em><span></span></em></div>
			</div>
		</div>
	</div>
</div>

<script id="T_plist" type="text/x-handlebars-template">
{{#if rows.length}}
	<div class="ui-all-check-wrap">
	    <label class="checkbox" for="all-check" style="font-size:16px;color:#A48B33;">
	        <input id="all-check" type="checkbox" name="all-check" checked="checked" style="margin: 1px 20px 0 0;">全选
	    </label>
	</div>
	<ul class="ui-plist fn-clear">
		{{#each rows}}
			<li class="fn-clear" data-collect="{{iscollect}}" data-img="{{appPic}}" data-nodeuid="{{nodeUid}}" data-appid="{{appID}}" data-appname="{{appName}}" carId="{{carId}}" sysType="{{sysType}}" offerId="{{offerId}}" {{switchCode month threeSmsCode threeOfferCode sixSmsCode sixOfferCode twelveSmsCode twelveOfferCode}}>
		        <input class="ui-scart-check" type="checkbox" name="check-{{appID}}" checked="checked">
				<a href="prodDtl.html?appID={{appID}}&nodeUid={{nodeUid}}&month={{month}}" target="_blank" class="fn-left">
					<img src="../{{appPic}}" width="100" height="56">
				</a>
				<div class="ui-plist-info">
					<a href="prodDtl.html?appID={{appID}}&nodeUid={{nodeUid}}&month={{month}}" class="ui-plist-name" target="_blank">{{appName}}</a>
					<div class="ui-plist-dtl">
						<span>
							金额：
							{{#if_eq month compare="3"}}
								<span class="J_price" style="color:#FE631F;">{{threepromprice}}</span>
							{{/if_eq}}
							{{#if_eq month compare="6"}}
								<span class="J_price" style="color:#FE631F;">{{sixpromprice}}</span>
							{{/if_eq}}
							{{#if_eq month compare="12"}}
								<span class="J_price" style="color:#FE631F;">{{twelvepromprice}}</span>
							{{/if_eq}}
							元</span>|&nbsp;&nbsp;
						<span>
							包月：<span class="J_month">{{month}}</span>个月
						</span>
					</div>
				</div>
				<a href="javascript:;" class="ui-btn ui-sbtn ui-btn-sgreen J_clt fn-hide" onclick="doCollect('{{appID}}','{{appName}}','{{nodeUid}}','{{isMutiApp}}','{{appPic}}',this)">收藏</a>
				<a href="javascript:;" class="ui-btn ui-sbtn ui-btn-sgreen J_cancelClt fn-hide" onclick="cancelCollect('{{appID}}',this)">取消收藏</a>
				<a href="javascript:;" class="ui-btn ui-sbtn ui-btn-red J_dlt" onclick="dltProd('{{carId}}')">删除</a>
			</li>
		{{/each}}
		<li class="fn-clear">
			<form id="prodForm" method="post" action="{{confirmCar}}">
				<input type="hidden" id="J_prod" name="prodInfo">
				<input type="hidden" name="prev" value="1">
			</form>
			<span class="ui-sumPrice">
				总计：<span id="J_sumPrice" style="font-size:20px;color:#FE631F;">0</span>元
			</span>
			<a href="javascript:;" class="ui-btn ui-btn-orange ui-settle" style="" onclick="payment()">
				<span style="font-weight:700;">$</span>&nbsp;&nbsp;结 算
			</a>
		</li>
	</ul>
{{else}}
	<ul><li class="ui-list-null">您的购物车还是空的，快去<a href="index.html" style="text-decoration:underline;">购物</a>吧~</li></ul>
{{/if}}
</script>

<script type="text/javascript" src="../lib/json2/1.0.0/json2.js"></script>
<script type="text/javascript" src="../lib/jquery/1.8.1/jquery.js"></script>
<script type="text/javascript" src="../lib/jqueryui/1.11.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="../lib/cookie/1.2.0/jquery.cookie.js"></script>
<script type="text/javascript" src="../lib/handlebars/1.3.0/handlebars.js"></script>
<script type="text/javascript" src="../lib/handlebars/1.3.0/helpers.js"></script>
<script type="text/javascript" src="../lib/cryptojs/3.1.2/core-min.js"></script>
<script type="text/javascript" src="../lib/cryptojs/3.1.2/enc-base64-min.js"></script>
<script type="text/javascript" src="../lib/dialog/4.1.7/artDialog.js"></script>
<script type="text/javascript" src="../lib/dialog/4.1.7/iframeTools.js"></script>
<script type="text/javascript" src="../common/config.js"></script>
<script type="text/javascript" src="../common/common.js?v=20141112"></script>
<script type="text/javascript">
var doCFlag = true;//收藏开关
var cancCFlag = true;//取消收藏开关
var delFlag = true;//删除购物车开关
$(function(){
	srvMap.add('sCartList', 'sCartList.json','common.action?uid=getAppCar');//购物车列表
	srvMap.add('collect', 'validRtn.json','common.action?uid=saveAppfavorite');//收藏
	srvMap.add('cancelCollect', 'validRtn.json','common.action?uid=cancelFavorite');//取消收藏
	srvMap.add('deleteCar', 'validRtn.json','common.action?uid=delAppCarById');//删除购物车
	srvMap.add('confirmCar', 'confirmCar.json','forwordTo.action?redirect=confirmBill.html&forword=confirmBill');//提交购物车
	sCartList();//初始化购物车列表
})

//购物车列表
function sCartList(){
	var sumPrice = 0;
	Util.ajax.postJson(srvMap.get('sCartList'),'',function(json,status){
		if (status) {
			json.confirmCar = srvMap.get('confirmCar');
			Util.ajax.loadTemp('#J_plist',$('#T_plist'),json);
			// 判断产品是否收藏
			$('#J_plist li').each(function(){
				var _this = $(this);
				var isCollect = _this.data('collect');
				if (isCollect == '1') {
					_this.find('.J_clt').show();
					_this.find('.J_cancelClt').hide();
				}else{
					_this.find('.J_clt').hide();
					_this.find('.J_cancelClt').show();
				}
			})
			//计算总金额
			$('.ui-plist .J_price').each(function(){
	            var _this = $(this);
				sumPrice += _this.text()?parseFloat(_this.text()):0;
			})
			$('#J_sumPrice').text(sumPrice);
			//设置全选，全不选
	        $('#all-check').click(function(){
	            var _this = $(this);
	            var prodCheckbox = $('.ui-plist').find('input:checkbox');
	            if (_this.attr('checked')) {
	                prodCheckbox.attr('checked','checked');
	                sumPrice = 0;
					$('.ui-plist .J_price').each(function(){
			            var _this = $(this);
						sumPrice += _this.text()?parseFloat(_this.text()):0;
					})
					$('#J_sumPrice').text(sumPrice);
	            }else{
	                prodCheckbox.removeAttr('checked');
	                sumPrice = 0;
					$('#J_sumPrice').text(sumPrice);
	            }
	        })
	        $('.ui-plist').on('click','input[type=checkbox]',function(){
	            var _this = $(this);
	            //计算总金额
	            if (_this.attr('checked')) {
	            	var addPrice = _this.siblings('.ui-plist-info').find('.J_price').text();
	            	addPrice = addPrice?parseFloat(addPrice):0;
	            	sumPrice += addPrice;
					$('#J_sumPrice').text(sumPrice);
	            }else{
	            	var minusPrice = _this.siblings('.ui-plist-info').find('.J_price').text();
	            	sumPrice -=minusPrice?parseFloat(minusPrice):0;
					$('#J_sumPrice').text(sumPrice);
	            }
	        	//当产品全部被选中后，全选按钮自动选中，取消时，全选按钮自动取消选中
	            var typ_length = $('.ui-plist').find('input:checkbox').length;
	            var flag = '';
	            for (var i = 0; i < typ_length; i++) {
	                if (!($('.ui-plist').find('input:checkbox').eq(i).attr('checked')))
	                    flag += 1;
	                else
	                    flag += 2;
	            }
	            if (flag.indexOf(1) <0) {
	                $('#all-check').attr('checked','checked');
	            }else{
	                $('#all-check').removeAttr('checked');
	            }
	        })
		}else{
			$('#J_plist').html('<div class="ui-load-error"></div>')
		}
	})
}
//收藏
function doCollect(appID,appName,nodeUid,isMutiApp,appPic,obj){
	if (doCFlag) {
		doCFlag = false;
		var datas = 'appID='+appID+'&appName='+encodeURIComponent(appName)+'&nodeUid='+nodeUid+'&isMutiApp='+isMutiApp+'&appPic='+appPic;
		
		Util.ajax.postJson(srvMap.get('collect'),{datas:datas,flg:1},function(json,status){
			if (status) {
				art.dialog.tips("收藏成功！");
				$(obj).hide();
				$(obj).next().show();
			}else{
				art.dialog.tips(json.rtnMsg||'连接失败，请重试！');
			}
			doCFlag = true;
		})
	}
}
//取消收藏
function cancelCollect(appID,obj){
	if (cancCFlag) {
		cancCFlag = false;
		Util.ajax.postJson(srvMap.get('cancelCollect'),'appID='+appID,function(json,status){
			if (status) {
				art.dialog.tips("取消收藏成功！");
				$(obj).prev().show();
				$(obj).hide();
			}else{
				art.dialog.tips(json.rtnMsg||'连接失败，请重试！');
			}
			cancCFlag = true;
		})
	};
}
//单个删除购物车中的产品
function dltProd(carId){
	if (delFlag) {
		delFlag = false;
		Util.ajax.postJson(srvMap.get('deleteCar'),'carId='+carId,function(json,status){
			if (status) {
				art.dialog.tips(json.rtnMsg||"删除成功！");
				sCartList();
			}else{
				art.dialog.tips(json.rtnMsg||'删除失败，请重试！');
			}
			delFlag = true;
		})
	}
}
//结算
function payment(){
	var prod = [];
	$('#J_plist li').each(function(){
	    var _this = $(this);
	    if (_this.find('input:checkbox').attr('checked')) {
		    var temp = {
			    'appID' : ''+_this.data('appid'),
			    'carId' : ''+_this.attr('carId'),
			    'appName' : _this.data('appname'),
			    'nodeUid' : _this.data('nodeuid'),
			    'price' : _this.find('.J_price').text(),
			    'month' : _this.find('.J_month').text(),
			    'appPic' : _this.data('img'),
			    'smsCode' : _this.attr('smsCode'),
			    'offerId' : _this.attr('offerId'),
			    'offerCode' : _this.attr('offerCode')
		    }
		    prod.push(temp);
	    };
	})
	if (prod.length) {
		prod = JSON.stringify(prod);
		prod = Util.transCoding(prod);//编码加密
		$('#J_prod').val(prod);
		$('#prodForm').submit();
	}else{
		art.dialog.tips('请选择要购买的产品！');
	}
}


Handlebars.registerHelper('switchCode', function(month,threeSCode,threeOCode,sixSCode,sixOCode,tweSCode,tweOCode ,fn) {
	if (month == '3'){
		return 'smsCode='+threeSCode+' offerCode='+threeOCode;
	}else if (month == '6') {
		return 'smsCode='+sixSCode+' offerCode='+sixOCode;
	}else{
		return 'smsCode='+tweSCode+' offerCode='+tweOCode;
	}
})

</script>
</body>
</html>